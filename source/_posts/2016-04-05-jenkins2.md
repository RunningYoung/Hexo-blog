---
layout: post
title: "iOSæŒç»­é›†æˆï¼šjenkins+gitlab+è’²å…¬è‹±+é‚®ä»¶é€šçŸ¥(Part 2)"
description: ""
category: iOS
tags: [jenkins]
imagefeature: pic-2014-09-08.jpg
comments: true
mathjax: null
featured: true
published: true
---



# iOSæŒç»­é›†æˆï¼šjenkins+gitlab+è’²å…¬è‹±+é‚®ä»¶é€šçŸ¥(Part 2)




## Jenkins ç³»ç»Ÿè®¾ç½® å‰æœŸå‡†å¤‡

<!--more-->

### Jenkins æ’ä»¶å®‰è£…


  * å®‰è£…GitLabæ’ä»¶
  	  å› ä¸ºæˆ‘ä»¬é¡¹ç›®ç”¨çš„æ˜¯GitLabæ¥ç®¡ç†æºä»£ç ï¼Œjenkinsæœ¬èº«å¹¶æ²¡æœ‰è‡ªå¸¦GitLabæ’ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¾æ¬¡é€‰æ‹© ***ç³»ç»Ÿç®¡ç† -> ç®¡ç†æ’ä»¶*** åœ¨"***å¯é€‰æ’ä»¶***"ä¸­é€‰æ‹©GitLab Plugin å’Œ Gitlab Hook Plugin è¿™ä¸¤é¡¹ï¼Œç„¶åå®‰è£…
  	  
  * å®‰è£…Xcodeæ’ä»¶
    åŒå®‰è£…GitLabæ’ä»¶æ­¥éª¤ä¸€æ ·ï¼Œæˆ‘ä»¬ä¸€æ¬¡é€‰æ‹©  ***ç³»ç»Ÿç®¡ç† -> ç®¡ç†æ’ä»¶*** åœ¨"***å¯é€‰æ’ä»¶***"ä¸­é€‰æ‹©Xcode integrationè¿™ä¸¤é¡¹ï¼Œç„¶åå®‰è£…
    
  *  å®‰è£…ç­¾åè¯ä¹¦ç®¡ç†æ’ä»¶
		iOSæ‰“åŒ…å†…æµ‹ç‰ˆæ—¶ï¼Œéœ€è¦å‘å¸ƒè¯ä¹¦åŠç›¸å…³ç­¾åæ–‡ä»¶ï¼Œå› æ­¤è¿™ä¸¤ä¸ªæ’ä»¶å¯¹äºç®¡ç†iOSè¯ä¹¦éå¸¸æ–¹ä¾¿ã€‚è¿˜æ˜¯åœ¨***ç³»ç»Ÿç®¡ç†->ç®¡ç†æ’ä»¶***ï¼Œåœ¨â€œ***å¯é€‰æ’ä»¶***â€ä¸­é€‰ä¸­â€œCredentials Pluginâ€å’Œâ€œKeychains and Provisioning Profiles Managementâ€å®‰è£…ã€‚
		
 *	 å®‰è£…FTPæ’ä»¶
 	 æ­¤æ’ä»¶å¯ç”¨äºä¸Šä¼ FTPæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ åˆ°å…¬å¸å†…ç½‘çš„FTPæœåŠ¡å™¨ä¸­ã€‚"Publish over FTP"
 	 
 * å®‰è£…è„šæœ¬æ’ä»¶
 	 è¿™ä¸ªæ’ä»¶ä¸»è¦ç”¨äºbuildåæ‰§è¡Œå…ˆå…³è„šæœ¬."Publish over FTP"
 	 
### jenkins ç³»ç»Ÿé…ç½®


#### jenkins å®‰å…¨è®¾ç½®ï¼šæ³¨å†Œï¼Œç™»å½•


 è¿›å…¥ ***ç³»ç»Ÿç®¡ç†->Configure Global Security*** é¦–æ¬¡è®¾ç½®å¦‚å›¾æ‰€ç¤ºï¼š
 
 ![é¦–æ¬¡è®¾ç½®](../images/jenkins/login1.png)


 é¦–æ¬¡è®¾ç½®å®Œç‚¹å‡»ä¿å­˜ï¼Œç„¶åç‚¹å‡»æ³¨å†Œ->ç™»å½•è´¦å·ï¼Œåœ¨è¿›å…¥è¯¥ç•Œé¢è¿›è¡Œè´¦å·æƒé™è®¾ç½®ï¼Œå¦‚å›¾
 
  ![æƒé™è®¾ç½®](../images/jenkins/login2.png)

#### jenkins ç³»ç»Ÿè®¾ç½®
è¿›å…¥ ***ç³»ç»Ÿç®¡ç†->ç³»ç»Ÿè®¾ç½®*** ç•Œé¢ï¼š

* é¦–å…ˆè®¾ç½®ä¸€ä¸‹ jenkins å†…éƒ¨shell æ‰§è¡Œç¼–ç ï¼Œç›®çš„å½“åœ¨jenkinsæ‰§è¡Œshellå‘½ä»¤æ—¶ï¼Œæœ‰æ—¶å€™ä¼šæŠ¥ utf-8 ç¼–ç é”™è¯¯ã€‚ä¸»è¦æ˜¯pod installçš„æ—¶å€™æŠ¥é”™ã€‚
	
	```
	[33mWARNING: CocoaPods requires your terminal to be using UTF-8 encoding.
	```
	è®¾ç½®å¦‚ä¸‹ï¼š
	
	![ç¼–ç è®¾ç½®](../images/jenkins/lang.png)
	
* jenkins Location è®¾ç½®
  ä¸»è¦è®¾ç½® jenkins å¤–éƒ¨è®¿é—®çš„URL å’Œ ç³»ç»Ÿç®¡ç†å‘˜çš„é‚®ç®±åœ°å€ã€‚ç”¨æ¥å‘é€ é”™è¯¯æŠ¥å‘Šçš„é‚®ç®±åœ°å€ï¼šå¦‚å›¾
  
  ![urlè®¾ç½®](../images/jenkins/location.png)
  
* ç³»ç»Ÿé”™è¯¯æŠ¥å‘Šçš„é‚®ç®±è®¾ç½®ï¼Œä¸Šé¢åªè®¾ç½®äº†é‚®ç®±å‘é€çš„åœ°å€ï¼ˆFromåœ°å€ï¼‰ï¼Œä¸‹é¢è®¾ç½®ï¼Œé‚®ç®±çš„æœåŠ¡å™¨ï¼Œåè®®ï¼Œé‚®ç®±ï¼Œå¯†ç ã€‚å¦‚å›¾
 	
 	![emailè®¾ç½®](../images/jenkins/email.png)
 	
## Jenkins ä»»åŠ¡ï¼ˆJobsï¼‰æ­å»º


### æ–°å»ºä»»åŠ¡ job


  åœ¨Jenkinsä¸­ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½æ˜¯ä»¥â€œitemâ€ä¸ºå•ä½çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ–°å»ºä¸€ä¸ªiOSçš„é¡¹ç›®æ¥å¼€å§‹è‡ªåŠ¨åŒ–æ„å»ºã€‚ç‚¹å‡»â€œæ–°å»ºâ€ï¼Œè¾“å…¥itemçš„åç§°ï¼Œé€‰æ‹©â€œæ„å»ºä¸€ä¸ªè‡ªç”±é£æ ¼çš„è½¯ä»¶é¡¹ç›®â€ï¼Œç„¶åç‚¹å‡»â€œOKâ€ã€‚å¦‚å›¾ï¼š


  
  ![æ–°å»ºJobè®¾ç½®](../images/jenkins/createjob1.png)


 
 è®¾ç½®æ„å»ºä¿¡æ¯


 
 ![æ„å»ºä¿¡æ¯è®¾ç½®](../images/jenkins/name.png)


 
### æºç ç®¡ç†
è¿™é‡Œç”¨åˆ°çš„æ˜¯GitLabï¼Œå…ˆéœ€è¦é…ç½®SSHï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Jenkinsçš„è¯ä¹¦ç®¡ç†ä¸­æ·»åŠ SSHã€‚åœ¨Jenkinsç®¡ç†é¡µé¢ï¼Œé€‰æ‹©â€œCredentialsâ€ï¼Œç„¶åé€‰æ‹©â€œGlobal credentials (unrestricted)â€ï¼Œç‚¹å‡»â€œAdd Credentialsâ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¡«å†™è‡ªå·±çš„SSHä¿¡æ¯ï¼Œç„¶åç‚¹å‡»â€œSaveâ€ï¼Œè¿™æ ·å°±æŠŠSSHæ·»åŠ åˆ°Jenkinsçš„å…¨å±€åŸŸä¸­å»äº†ã€‚
è¿™è¾¹éœ€è¦æ³¨æ„çš„æ˜¯å¦‚ä½•è·å–SSH keyï¼šè¿™ä¸ªé—®é¢˜éœ€è¦å‚è€ƒ gitLab ä¸Šé…ç½®SSH çš„æ–¹æ³•ã€‚

1. æŸ¥çœ‹æ˜¯å¦å·²ç»æœ‰äº†sshå¯†é’¥ï¼šcd ~/.sshï¼Œå¦‚æœæ²¡æœ‰å¯†é’¥åˆ™ä¸ä¼šæœ‰æ­¤æ–‡ä»¶å¤¹ï¼Œæœ‰åˆ™å¤‡ä»½åˆ é™¤
2. ç”Ÿæˆå¯†é’¥ï¼š`$ ssh-keygen -t rsa -C â€œhaiyan.xu.vip@gmail.comâ€` ç”Ÿæˆè¿‡ç¨‹ä¸­å¿…é¡»è®¾ç½®ç§˜é’¥å¯†ç  å¦åˆ™jenkins è®¾ç½®ä¼šä¸æˆåŠŸã€‚æœ€åå¾—åˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼šid_rsaå’Œid_rsa.pub
3. æ·»åŠ å¯†é’¥åˆ°SSH ï¼š`ssh-add æ–‡ä»¶å` éœ€è¦è¾“å…¥ç®¡ç†å¯†ç 
4. åœ¨gitlab ä¸Šæ·»åŠ  ssh å¯†é’¥ï¼Œè¿™é‡Œæ·»åŠ çš„æ˜¯ "id_rsa.pub"é‡Œé¢çš„å…¬é’¥ã€‚
5. åœ¨jenkinsä¸Šé…ç½®å¯†é’¥åˆ°SSH ï¼Œè¿™é‡Œæ·»åŠ çš„æ˜¯id_rsaé‡Œé¢çš„ç§é’¥ã€‚å…·ä½“è®¾ç½®å¦‚å›¾æ‰€ç¤ºï¼š

![](../images/jenkins/ssh.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†å›åˆ°åˆšåˆšæ–°å»ºçš„ä»»åŠ¡ä¸­ï¼Œåœ¨æºç ç®¡ç†ä¸­ï¼Œé€‰æ‹©Gitï¼ŒæŒ‰ä¸‹å›¾å¡«å¥½ç›¸å…³ä¿¡æ¯ã€‚PSï¼šCredentialsä¸éœ€è¦é€‰æ‹©ã€‚å¦‚å›¾

![](../images/jenkins/git.png)

### æ„å»ºè§¦å‘å™¨è®¾ç½®


è¯¥è®¾ç½®ä¸»è¦æ˜¯ä¸ºäº†å®ç°è‡ªåŠ¨è§¦å‘ jenkins æ„å»ºè¿‡ç¨‹ çœŸæ­£å®ç°è‡ªåŠ¨åŒ–è®¾ç½®:
è¿™è¾¹ä¸»è¦å¤„ç†çš„æ˜¯ ***gitlab hook*** çš„è®¾ç½®ã€‚ä¸»è¦ç›®çš„æ˜¯å½“é¡¹ç›®ä¸­æœ‰äººgit push æäº¤è¿‡ä»£ç ä¹‹åï¼Œå°±ä¼šè‡ªåŠ¨çš„è§¦å‘ jenkins çš„æœ¬Jobçš„æ„å»ºï¼Œå®ç°è‡ªåŠ¨åŒ–æ‰“åŒ…ã€‚

1. é¦–é€‰éœ€è¦åœ¨gitlab é¡¹ç›®ç®¡ç†å®˜ç½‘ä¸Šè®¾ç½® æ·»åŠ git hook çš„åœ°å€ï¼šå¦‚å›¾ï¼šè¯¥åœ°å€æ˜¯jenkins ä¸Š æç¤ºçš„åœ°å€ ä¸‹é¢ä¼šæåˆ°
	 
![](../images/jenkins/gitlabhook.png)

2. jenkins ä¸Šå¯¹ gitlab hook è¿›è¡Œç›¸å…³é…ç½® å¦‚å›¾æ‰€ç¤ºï¼š

![](../images/jenkins/jenkinsgitlabhook.png)

### æ„å»ºç¯å¢ƒ


åœ¨è¯¥æ¨¡å—ä¸­ ä¸»è¦è®¾ç½® xcode build æ‰“åŒ…æ—¶éœ€è¦çš„ keychains å’Œ Provision Profiles é…ç½®æ–‡ä»¶ã€‚
å¦‚æœä¸é…ç½® å°±ä¼šä½¿ç”¨ xcode è‡ªåŠ¨çš„é…ç½®ï¼Œæ¥å»ç³»ç»Ÿä¸­æŸ¥æ‰¾ç›¸åº”çš„é…ç½®ï¼Œä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„,å°±æ˜¯é’¥åŒ™ä¸²ä¸­ï¼Œç™»é™†é’¥åŒ™ä¸²ä¸­çš„è¯ä¹¦ è¦å¤åˆ¶åˆ° ç³»ç»Ÿé’¥åŒ™ä¸²ä¸­ï¼Œå› ä¸ºjenkins è®¿é—®çš„æ˜¯ç³»ç»Ÿä¸­çš„é’¥åŒ™ä¸² è¿™æ ·åœ¨ç¬¬ä¸€æ¬¡æ‰“åŒ…çš„æ—¶å€™ï¼Œä¼šæç¤º æ˜¯å¦æˆæƒè®¿é—®é’¥åŒ™ä¸²ï¼Œç‚¹å‡»å§‹ç»ˆå…è®¸å°±å¯ä»¥äº†ã€‚
æ³¨æ„ï¼šåœ¨ç”µè„‘ä¸Šå®‰è£…å¥½ xcode é…ç½®ç›¸å…³çš„è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶ä¹Ÿè¦å®‰è£…åˆ°ç³»ç»Ÿç›®å½•ä¸‹ã€‚
å…·ä½“æ“ä½œå¦‚ä¸‹ï¼šä»è¯¥ç”¨æˆ·ç›®å½•ä¸‹çš„æ‰€æœ‰æè¿°æ–‡ä»¶

```
/Users/ç”¨æˆ·å/Library/MobileDevice/Provisioning Profiles
```
å¤åˆ¶åˆ°ç³»ç»Ÿç›®å½•ä¸‹

```
/Library/MobileDevice/Provisioning Profiles
```

### æ„å»º


è¯¥æ¨¡å—å¼€å§‹è®¾ç½® iOSæ‰“åŒ…ç›¸å…³çš„é…ç½®ã€‚

1. ç‚¹å‡»å¢åŠ æ„å»ºæ­¥éª¤-> Execute Shell .é¦–å…ˆ åœ¨build ä¹‹å‰éœ€è¦å…ˆ pod install ï¼Œå¹¶ä¸”æœ€ç†æƒ³çš„æƒ…å†µæ˜¯æ¯æ¬¡æ„å»ºçš„æ—¶å€™ buildå·éƒ½æ”¹å˜ã€‚å¦‚å›¾æ‰€ç¤º
	éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨å…¨å±€å˜é‡æ—¶ å¿…é¡»æ‰¾åˆ°ç»å¯¹è·¯å¾„æ‰èƒ½è°ƒç”¨ç›¸å…³çš„å‘½ä»¤ï¼šç‰ˆæœ¬å·å¢åŠ [å‚è€ƒé“¾æ¥](https://www.5288z.com/?p=1651)
	
	![](../images/jenkins/pod.png)
	
2.  ç‚¹å‡»å¢åŠ æ„å»ºæ­¥éª¤ xcode ï¼Œå…·ä½“é…ç½®å¦‚å›¾ï¼š
	  è¯¥é…ç½®ä¸­éœ€è¦æ³¨æ„ åœ¨OS X 10.10.XXç‰ˆæœ¬ jenkins xcode æ’ä»¶ä¸æ”¯æŒ ç”Ÿæˆipaæ–‡ä»¶ï¼Œä½† OS X 10.11 æ”¯æŒ è¿™ä¸ªæ—¶å€™ éœ€è¦æ‰‹åŠ¨è¿›è¡Œæ‰“åŒ…ï¼Œå…·ä½“çš„å°±æ˜¯åœ¨build å®Œæˆä¹‹å æ·»åŠ EXecute Shell ï¼Œåˆ©ç”¨shellè„šæœ¬æ‰“åŒ…ï¼šä»£ç å¦‚ä¸‹ï¼š
	  
	  ```
	  xcrun -sdk iphones PackageApplication -v [å·¥ç¨‹ç›®å½•] -o [ipaè¾“å‡ºç›®å½•]/xx.ipa
	  ```
	  
	  
	  ![](../images/jenkins/xcode.png)
	  
3. Code signing & OS X keychain options é…ç½®ï¼šå¦‚å›¾
   
   ![](../images/jenkins/codesigning.png)
	
4. Advanced Xcode build options é…ç½®ï¼šå¦‚å›¾
	 
	 ![](../images/jenkins/xcodebuild.png)

### æ„å»ºåæ“ä½œ


 æ‰“åŒ…å®Œæˆä¹‹å éœ€è¦æ‰§è¡Œ ä¸Šä¼ åˆ°è’²å…¬è‹± å’Œ å‘é€é‚®ä»¶ é€šçŸ¥å¼€å‘äººå‘˜ã€‚
   å…·ä½“æ“ä½œæˆ‘ç”¨pythonå†™çš„è„šæœ¬æ¥å®Œæˆæ­¤åŠŸèƒ½ï¼šéœ€è¦çš„ç«¥é‹å¯ä»¥å»githubä¸Šä¸‹è½½ï¼šåœ¨æ–‡ç« æœ€åï¼ï¼
   å…·ä½“è°ƒç”¨å¦‚å›¾ï¼š
    
![](../images/jenkins/pgy.png)
  
  æœ€åè®¾ç½® é€šçŸ¥é‚®ä»¶ E-mail Notification å¡«å†™æ¥å—é‚®ç®±å³å¯ æ¯æ¬¡æ„å»ºå¤±è´¥éƒ½ä¼šå‘ç”Ÿé‚®ä»¶é€šçŸ¥ï¼ï¼ï¼
 
  
 [python è„šæœ¬åœ°å€](https://github.com/RunningYoung/jenkins-pgy-python)!!! ä¸è¦åå•¬ starï¼ï¼ï¼ä¸èƒœæ„Ÿæ¿€ï¼ï¼ï¼ 

	
 
 
 

